package pentester

import (
	"fmt"
	"strconv"
	"strings"

	"github.com/spf13/cobra"
	"github.com/yourusername/cyverApiCli/cmd/shared"
	"github.com/yourusername/cyverApiCli/internal/api/versions/v2_2"
	"github.com/yourusername/cyverApiCli/internal/errors"
)

// Labels command group
var labelsCmd = &cobra.Command{
	Use:   "labels",
	Short: "Manage label operations",
	Long:  `Manage label information and operations for pentesters.`,
}

// List labels command
var listLabelsCmd = &cobra.Command{
	Use:   "list",
	Short: "List labels (pentester view)",
	Long:  `Retrieve a paginated list of labels with optional filtering using pentester operations.`,
	Run: func(cmd *cobra.Command, args []string) {
		clientVersion := shared.GetVersionedApiClient()
		if clientVersion == nil {
			shared.HandleError(cmd, errors.NewCyverError(errors.ErrCodeConfigInvalid, "failed to initialize API client", nil))
			return
		}

		// Type switch to handle different client versions
		switch client := clientVersion.(type) {
		case *v2_2.Client:
			if client.PentesterOps == nil {
				shared.HandleError(cmd, errors.NewCyverError(errors.ErrCodeUnexpectedType, "PentesterOps is nil for v2.2 client", nil))
				return
			}

			// Get flag values with defaults
			typeStr, _ := cmd.Flags().GetString("type")
			maxResults, _ := cmd.Flags().GetInt("max-results")
			skipCount, _ := cmd.Flags().GetInt("skip-count")
			filter, _ := cmd.Flags().GetString("filter")

			// Convert type string to enum value
			// API documentation: 0 = Finding, 1 = Client, 2 = Project, 3 = Assets, 4 = All
			// Default to "4" (All) if not provided
			var typeValue string = "4" // Default to All
			if typeStr != "" {
				typeLower := strings.ToLower(typeStr)
				switch typeLower {
				case "finding", "0":
					typeValue = "0" // Finding
				case "client", "1":
					typeValue = "1" // Client
				case "project", "2":
					typeValue = "2" // Project
				case "assets", "asset", "3":
					typeValue = "3" // Assets
				case "all", "4":
					typeValue = "4" // All
				default:
					// Try to parse as integer
					if val, err := strconv.Atoi(typeStr); err == nil {
						if val >= 0 && val <= 4 {
							typeValue = typeStr
						} else {
							shared.HandleError(cmd, errors.NewCyverError(errors.ErrCodeValidationFailed,
								fmt.Sprintf("Invalid label type '%s'. Valid options are: finding (0), client (1), project (2), assets (3), all (4)", typeStr), nil))
							return
						}
					} else {
						shared.HandleError(cmd, errors.NewCyverError(errors.ErrCodeValidationFailed,
							fmt.Sprintf("Invalid label type '%s'. Valid options are: finding (0), client (1), project (2), assets (3), all (4)", typeStr), nil))
						return
					}
				}
			}

			pagedResult, err := client.PentesterOps.ApiV22PentesterLabelsGet(typeValue, maxResults, skipCount, filter)
			if err != nil {
				shared.HandleError(cmd, err)
				return
			}

			// Get the output format option and validate it
			outputFormat, _ := cmd.Flags().GetString("output")

			// Validate output format
			validFormats := []string{"json", "table", "custom"}
			isValidFormat := false
			for _, format := range validFormats {
				if outputFormat == format {
					isValidFormat = true
					break
				}
			}

			if !isValidFormat {
				shared.HandleError(cmd, errors.NewCyverError(errors.ErrCodeValidationFailed,
					fmt.Sprintf("Invalid output format '%s'. Valid options are: %s", outputFormat, strings.Join(validFormats, ", ")), nil))
				return
			}

			// Use the output format-specific function
			switch outputFormat {
			case "json":
				if err := shared.PrintJSONResponse(pagedResult); err != nil {
					shared.HandleError(cmd, err)
				}
			case "table":
				// Use custom table for labels since there's no specific label table function
				maxColumns, _ := cmd.Flags().GetInt("max-columns")
				if maxColumns <= 0 {
					maxColumns = 4 // Default to 4 columns
				}
				if err := shared.PrintCustomTable(pagedResult, maxColumns); err != nil {
					shared.HandleError(cmd, err)
				}
			case "custom":
				maxColumns, _ := cmd.Flags().GetInt("max-columns")
				if maxColumns <= 0 {
					maxColumns = 4 // Default to 4 columns
				}
				if err := shared.PrintCustomTable(pagedResult, maxColumns); err != nil {
					shared.HandleError(cmd, err)
				}
			}

		default:
			shared.HandleError(cmd, errors.NewCyverError(errors.ErrCodeUnexpectedType, fmt.Sprintf("unsupported client type: %T", clientVersion), nil))
			return
		}
	},
}

// Initialize function to register all labels commands
func init() {
	// Add flags to list labels command
	// Type: 0 = Finding, 1 = Client, 2 = Project, 3 = Assets, 4 = All (default)
	listLabelsCmd.Flags().String("type", "4", "Filter by label type (finding/0, client/1, project/2, assets/3, all/4). Default: all (4)")
	listLabelsCmd.Flags().Int("max-results", 10, "Maximum number of results (default: 10)")
	listLabelsCmd.Flags().Int("skip-count", 0, "Number of results to skip (default: 0)")
	listLabelsCmd.Flags().String("filter", "", "Filter string")
	listLabelsCmd.Flags().StringP("output", "o", "table", "Output format (json, table, custom)")
	listLabelsCmd.Flags().Int("max-columns", 4, "Maximum number of columns for custom table output")

	// Add all commands to the labels command group
	labelsCmd.AddCommand(listLabelsCmd)

	// Commands will be added to pentester command group via InitPentesterCommands
}
